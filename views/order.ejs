<!-- order.ejs -->

<!DOCTYPE html>
<html lang="en">

<head>
  <title>Order Page</title>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="/vendor/normalize-4.1.1.css" />
  <link rel="stylesheet" href="/vendor/border-box.css" />
  <link rel="stylesheet" href="/styles/main.css" />
  <link rel="stylesheet" href="/styles/layout.css" />

  <script src="/vendor/jquery-3.0.0.js"></script>
  <script defer src="/routes/order.js"></script>
</head>

<body>
  <!-- Restaurant banner with name and address -->
  <div class="banner">
    <h1>Restaurant Name</h1>
    <p>Restaurant Address</p>
  </div>

  <!-- Notifications placeholder -->
  <div class="notifications">
    <!-- Add your notifications content here -->
  </div>

  <!-- Dish list -->
  <div class="dishes-list">
    <% dishes.forEach((dish) => { %>
    <div class="dish-row">
      <!-- Dish image placeholder -->
      <div class="dish-image">
        <img src="/images/dish_placeholder.jpg" alt="Dish Image">
      </div>

      <!-- Dish details -->
      <div class="dish-details">
        <h2><%= dish.name %></h2>
        <p><%= dish.description %></p>
        <p>Price: $<%= dish.price.toFixed(2) %></p>
        <!-- Quantity input and Add to Cart button -->
        <div class="quantity-controls">
          <input type="number" name="quantity_<%= dish.id %>" value="0" min="0">
          <button class="add-to-cart-button" data-dish-id="<%= dish.id %>">Add to Cart</button>
          <button class="delete-button" data-dish-id="<%= dish.id %>">Delete</button>
        </div>
      </div>
    </div>
    <% }); %>
  </div>

  <!-- Order form -->
  <div class="order-form">
    <form action="/place_order" method="POST">
      <!-- Phone number input -->
      <label for="phone">Phone Number:</label>
      <input type="text" id="phone" name="phone" required>

      <!-- Subtotal -->
      <div class="subtotal">
        <p>Subtotal: $<span id="subtotal">0.00</span></p>
      </div>

      <!-- Submit and Clear Cart buttons -->
      <div class="form-buttons">
        <button type="submit">Submit Order</button>
        <button type="button" id="clear-cart-button">Clear Cart</button>
      </div>
    </form>
  </div>

  <script>
    // Initialize an empty object to store dish data
    let dishesData = {};

    // Function to update the subtotal based on the selected quantities
    function updateSubtotal() {
      const quantityInputs = document.querySelectorAll('.quantity-controls input');
      let subtotal = 0;

      quantityInputs.forEach((input) => {
        const dishId = input.getAttribute('data-dish-id');
        const price = dishesData[dishId];
        const quantity = parseInt(input.value);

        subtotal += price * quantity;
      });

      document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    }

    // Event listener for the Add to Cart button
    document.querySelectorAll('.add-to-cart-button').forEach((button) => {
      button.addEventListener('click', (event) => {
        const dishId = button.getAttribute('data-dish-id');
        const quantityInput = document.querySelector(`.quantity-controls input[data-dish-id="${dishId}"]`);
        let quantity = parseInt(quantityInput.value);

        quantity += 1;
        quantityInput.value = quantity;

        updateSubtotal();
      });
    });

    // Event listener for the Delete button
    document.querySelectorAll('.delete-button').forEach((button) => {
      button.addEventListener('click', (event) => {
        const dishId = button.getAttribute('data-dish-id');
        const quantityInput = document.querySelector(`.quantity-controls input[data-dish-id="${dishId}"]`);

        quantityInput.value = '0';

        updateSubtotal();
      });
    });

    // Event listener for the Clear Cart button
    document.getElementById('clear-cart-button').addEventListener('click', (event) => {
      const quantityInputs = document.querySelectorAll('.quantity-controls input');

      quantityInputs.forEach((input) => {
        input.value = '0';
      });

      updateSubtotal();
    });

    // Fetch dishes data from the server API endpoint
    fetch('/api/dishes')
      .then(response => response.json())
      .then(data => {
        // Store dish data in the dishesData object using dish ID as the key
        data.forEach(dish => {
          dishesData[dish.id] = dish.price;
        });

        // Call updateSubtotal function to set the initial subtotal
        updateSubtotal();
      })
      .catch(error => console.error('Error fetching dishes data', error));
  </script>

</body>

</html>
